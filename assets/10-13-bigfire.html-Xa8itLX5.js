import{_ as a}from"./plugin-vue_export-helper-DlAUqK2U.js";import{r,o,c as n,d as e,e as i,a as s,b as c}from"./app-DrsE8OIX.js";const p="/work-blog/assets/ws-accident-scene-Cqu9sbSz.png",l="/work-blog/assets/lb-question-DHZiDyVu.png",d="/work-blog/assets/rr-lb-questions-DjO4jAm-.png",h={},m=c('<h1 id="现场" tabindex="-1"><a class="header-anchor" href="#现场"><span>现场</span></a></h1><figure><img src="'+p+'" alt="事故现场" tabindex="0" loading="lazy"><figcaption>事故现场</figcaption></figure><h1 id="起因" tabindex="-1"><a class="header-anchor" href="#起因"><span>起因</span></a></h1><p>瞬时流量激增（日常2倍）</p><h1 id="事件原因" tabindex="-1"><a class="header-anchor" href="#事件原因"><span>事件原因</span></a></h1><p>核心问题就是k8s集群的滚动更新机制和流量轮询策略导致sdkv9-ws上的连接数不均衡导致oom。</p><h1 id="负载不均问题" tabindex="-1"><a class="header-anchor" href="#负载不均问题"><span>负载不均问题</span></a></h1><p>对于长连接的服务，可能会存在负载不均的问题，下面介绍两种场景。</p><h2 id="滚动更新负载不均" tabindex="-1"><a class="header-anchor" href="#滚动更新负载不均"><span>滚动更新负载不均</span></a></h2><p>在连接数比较固定或波动不大的情况下，滚动更新时，旧 Pod 上的连接逐渐断掉，重连到新启动的 Pod 上，越先启动的 Pod 所接收到的连接数越多，造成负载不均。 <img src="'+l+'" alt="滚动更新负载不均衡" loading="lazy"></p><h2 id="rr-策略负载不均" tabindex="-1"><a class="header-anchor" href="#rr-策略负载不均"><span>rr 策略负载不均</span></a></h2><p>假如长连接服务的不同连接的保持时长差异很大，而 ipvs 转发时默认是 rr 策略转发，如果某些后端 Pod &quot;运气较差&quot;，它们上面的连接保持时间比较较长，而由于是 rr 转发，它们身上累计的连接数就可能较多，节点上通过 ipvsadm -Ln -t CLUSTER-IP:PORT 查看某个 service 的转发情况: <img src="'+d+'" alt="rr 策略负载不均" loading="lazy"> 部分 Pod 连接数高，意味着相比连接数低的 Pod 要同时处理更多的连接，着消耗的资源也就相对更多，从而造成负载不均。</p><h1 id="解决方案" tabindex="-1"><a class="header-anchor" href="#解决方案"><span>解决方案</span></a></h1><p>通过扩容2个ws容器完成修复</p><h1 id="参考" tabindex="-1"><a class="header-anchor" href="#参考"><span>参考</span></a></h1>',15),g={href:"https://imroc.cc/kubernetes/best-practices/long-connection",target:"_blank",rel:"noopener noreferrer"};function b(u,f){const t=r("ExternalLinkIcon");return o(),n("div",null,[m,e("p",null,[e("a",g,[i("长连接服务"),s(t)])])])}const x=a(h,[["render",b],["__file","10-13-bigfire.html.vue"]]),y=JSON.parse('{"path":"/work/10-13-bigfire.html","title":"Websocket服务雪崩","lang":"zh-CN","frontmatter":{"title":"Websocket服务雪崩","description":"公司内部一个长连接服务pod经常oom。","tag":["Linux","Kubernetes"],"head":[["meta",{"property":"og:url","content":"https://yuhaoxiang.github.io/work-blog/work-blog/work/10-13-bigfire.html"}],["meta",{"property":"og:site_name","content":"大杂烩"}],["meta",{"property":"og:title","content":"Websocket服务雪崩"}],["meta",{"property":"og:description","content":"公司内部一个长连接服务pod经常oom。"}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2024-11-15T01:10:45.000Z"}],["meta",{"property":"article:author","content":"yhx"}],["meta",{"property":"article:tag","content":"Linux"}],["meta",{"property":"article:tag","content":"Kubernetes"}],["meta",{"property":"article:modified_time","content":"2024-11-15T01:10:45.000Z"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"Websocket服务雪崩\\",\\"image\\":[\\"\\"],\\"dateModified\\":\\"2024-11-15T01:10:45.000Z\\",\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"yhx\\",\\"url\\":\\"/\\"}]}"]]},"headers":[{"level":2,"title":"滚动更新负载不均","slug":"滚动更新负载不均","link":"#滚动更新负载不均","children":[]},{"level":2,"title":"rr 策略负载不均","slug":"rr-策略负载不均","link":"#rr-策略负载不均","children":[]}],"git":{"createdTime":1731633045000,"updatedTime":1731633045000,"contributors":[{"name":"余浩翔","email":"1x2_ou6tn9m4r4@dingtalk.com","commits":1}]},"readingTime":{"minutes":1.33,"words":400},"filePathRelative":"work/10-13-bigfire.md","localizedDate":"2024年11月15日"}');export{x as comp,y as data};
