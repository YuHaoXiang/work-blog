import{_ as t}from"./plugin-vue_export-helper-DlAUqK2U.js";import{o as a,c as o,b as i}from"./app-DrsE8OIX.js";const r="/work-blog/assets/k8s_traffic_summay-CEBVO1nR.png",l="/work-blog/assets/gateway_resource_summary-D5KBaqwj.png",s="/work-blog/assets/gateway_pod_summary-MzclMrVp.png",e="/work-blog/assets/core-pod-summary-BJw2W-kh.png",n="/work-blog/assets/resource-limits-B33vhebd.png",c={},p=i('<h2 id="事故概述" tabindex="-1"><a class="header-anchor" href="#事故概述"><span>事故概述</span></a></h2><p>一个内部项目17点更新停服重启，停服开服运营没有做事先通知，大量用户下线在重新登录，瞬间流量超过平时4倍。</p><h2 id="事件分析" tabindex="-1"><a class="header-anchor" href="#事件分析"><span>事件分析</span></a></h2><h3 id="大量流量进入sdkv9-gateway服务" tabindex="-1"><a class="header-anchor" href="#大量流量进入sdkv9-gateway服务"><span>大量流量进入sdkv9-gateway服务</span></a></h3><figure><img src="'+r+'" alt="集群总流量图" tabindex="0" loading="lazy"><figcaption>集群总流量图</figcaption></figure><p>由 gateway服务整体资源图 和 gateway服务pod详细资源图 可以得出：</p><ol><li>gateway的cpu和内存资源充足</li><li>gateway服务扩容前抗住了流量压力</li><li>在18点10分的附近好像做个gateway的deployment改动操作，造成了2个左右容器的cpu使用率过高。 <img src="'+l+'" alt="gateway服务整体资源图" loading="lazy"><img src="'+s+'" alt="gateway服务pod详细资源图" loading="lazy"></li></ol><h3 id="流量转发至sdkv9-core服务" tabindex="-1"><a class="header-anchor" href="#流量转发至sdkv9-core服务"><span>流量转发至sdkv9-core服务</span></a></h3><p>由 sdkv9-core服务整体资源图 和 sdkv9-core服务pod详细资源图 可以得出：</p><ol><li>从整体资源图上看引起事故发生的第一原因是pod的cpu资源不够</li><li>在事故发生时已经将cpu资源做了扩容，此时cpu资源已经够用。17：40-17：46 短暂性的服务正常了，此时好像通知其他同事服务正常了</li><li>用户又开始登录了，在整体资源够用的情况下，扩容后的服务开始出现断断续续的NotReady，pod的cpu资源使用率持续性的飙升，这时候又做了二次扩容，三次扩容，四次扩容，四次扩容服务依然没有完全恢复。</li><li>18：10 进行事故第三次分析，发现单pod总是突破cpu上限，决定提高cpu的限制由2提高到3，但是突破了节点资源，部分pod无法启动，又由3赶紧调回2。再次分析面板锁定是健康检查机制导致的pod间歇性不可用，退而求其次移除健康检测机制，18:20左右服务阶段性正常。</li><li>18：20-18：50期间尝试性的调整过几次服务，把健康检查机制加回来，从监控中发现流量大的情况调整服务会引发流量波峰，会短暂出现NotReady，可能会引发服务雪崩（sdkv9-ip在此过程中崩过）。</li></ol><p><img src="'+e+'" alt="sdkv9-core服务整体资源图" loading="lazy"><img src="'+e+'" alt="sdkv9-core服务pod详细资源图" loading="lazy"></p><h3 id="其他服务" tabindex="-1"><a class="header-anchor" href="#其他服务"><span>其他服务</span></a></h3><ol><li>由于第一时间把流量大的其他服务（比如ws）也扩容了，所以其他没有产生较大的影响，这块算是一个经验缺失。</li><li>在后期cpu加的过多导致监控采集模块服务挂掉，这块和集群整体资源限制规划有关。在之前忽略了这块会引发的连锁反应。 <img src="'+n+'" alt="资源概览图" loading="lazy"></li></ol>',13),d=[p];function g(m,h){return a(),o("div",null,d)}const k=t(c,[["render",g],["__file","10-1-bigfire.html.vue"]]),_=JSON.parse('{"path":"/work/10-1-bigfire.html","title":"记一次十一线上事故","lang":"zh-CN","frontmatter":{"title":"记一次十一线上事故","description":"刚来公司第二个月，由大型活动触发的一个线上事故。","tag":["Linux","Kubernetes"],"head":[["meta",{"property":"og:url","content":"https://yuhaoxiang.github.io/work-blog/work-blog/work/10-1-bigfire.html"}],["meta",{"property":"og:site_name","content":"大杂烩"}],["meta",{"property":"og:title","content":"记一次十一线上事故"}],["meta",{"property":"og:description","content":"刚来公司第二个月，由大型活动触发的一个线上事故。"}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2024-11-15T01:10:45.000Z"}],["meta",{"property":"article:author","content":"yhx"}],["meta",{"property":"article:tag","content":"Linux"}],["meta",{"property":"article:tag","content":"Kubernetes"}],["meta",{"property":"article:modified_time","content":"2024-11-15T01:10:45.000Z"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"记一次十一线上事故\\",\\"image\\":[\\"\\"],\\"dateModified\\":\\"2024-11-15T01:10:45.000Z\\",\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"yhx\\",\\"url\\":\\"/\\"}]}"]]},"headers":[{"level":2,"title":"事故概述","slug":"事故概述","link":"#事故概述","children":[]},{"level":2,"title":"事件分析","slug":"事件分析","link":"#事件分析","children":[{"level":3,"title":"大量流量进入sdkv9-gateway服务","slug":"大量流量进入sdkv9-gateway服务","link":"#大量流量进入sdkv9-gateway服务","children":[]},{"level":3,"title":"流量转发至sdkv9-core服务","slug":"流量转发至sdkv9-core服务","link":"#流量转发至sdkv9-core服务","children":[]},{"level":3,"title":"其他服务","slug":"其他服务","link":"#其他服务","children":[]}]}],"git":{"createdTime":1731633045000,"updatedTime":1731633045000,"contributors":[{"name":"余浩翔","email":"1x2_ou6tn9m4r4@dingtalk.com","commits":1}]},"readingTime":{"minutes":2.43,"words":729},"filePathRelative":"work/10-1-bigfire.md","localizedDate":"2024年11月15日"}');export{k as comp,_ as data};
